services:
  comfyui:
    # Use base image directly - no custom build needed
    image: yanwk/comfyui-boot:cu126-slim
    container_name: comfyui
    restart: unless-stopped
    init: true
    ports:
      - "8188:8188"  # ComfyUI (Coolify can override if needed)
    environment:
      - HF_HOME=/root/.cache/huggingface/hub
      - HF_TOKEN=${HF_TOKEN}
      - PYTHONUNBUFFERED=1
      - S3_ENDPOINT=${S3_ENDPOINT:-https://minio-api.v1su4.com}
      - S3_ACCESS_KEY=${S3_ACCESS_KEY}
      - S3_SECRET_KEY=${S3_SECRET_KEY}
      - S3_MODELS_BUCKET=${S3_MODELS_BUCKET:-storage-models}
      - S3_MODELS_PATH=${S3_MODELS_PATH:-models}
      - S3_USER_BUCKET=${S3_USER_BUCKET:-storage-user}
      - CLI_ARGS=
    volumes:
      # Mount entrypoint script to override base image's entrypoint
      - ./entrypoint-comfyui.sh:/custom-entrypoint.sh:ro
      # Storage - S3 will be mounted by entrypoint, these are fallback
      - ./storage:/root
      # Note: Model directories will be symlinked to S3 by entrypoint script
      # Local volumes are kept as fallback if S3 is not configured
    entrypoint: ["/bin/bash", "/custom-entrypoint.sh"]
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:8188/')\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    security_opt:
      - "label=disable"
      - "seccomp=unconfined"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]
  swarmui:
    image: gordov1su4/swarmui:v0.3.3
    container_name: swarmui
    restart: unless-stopped
    depends_on:
      - comfyui
    ports:
      - "7801:7801"
    environment:
      - WORKSPACE=/workspace
      - COMFYUI_HOST=comfyui
      - COMFYUI_PORT=8188
      - PYTHONUNBUFFERED=1
    volumes:
      - swarmui_data:/workspace/SwarmUI
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:7801/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
volumes:
  swarmui_data:
    driver: local
